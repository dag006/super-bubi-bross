
<html lang="it">
<head>
<meta charset="UTF-8">
<title>Lv4: The Fortress (Final Version)</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<style>
    @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');
    @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@700&display=swap');
    @import url('https://fonts.googleapis.com/css2?family=Dancing+Script:wght@700&display=swap');

    body { margin: 0; overflow: hidden; background: #050505; font-family: 'Press Start 2P', cursive; user-select: none; -webkit-touch-callout: none; }
    canvas { display: block; width: 100%; height: 100%; image-rendering: pixelated; }

    #ui { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10; }

    #hud-top {
        position: absolute; top: 20px; left: 20px; right: 20px;
        display: flex; justify-content: space-between; align-items: flex-start;
    }
    .heart-container { display: flex; gap: 5px; }
    .heart {
        width: 30px; height: 30px;
        background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 10 10"><path fill="%23e91e63" d="M2 1h2v1h-2zM6 1h2v1h-2zM1 2h1v1h-1zM5 2h0v1h0zM9 2h0v1h-0zM8 2h1v1h-1zM0 3h1v1h-1zM9 3h1v1h-1zM1 4h1v1h-1zM9 4h0v1h-0zM8 4h1v1h-1zM2 5h1v1h-1zM7 5h1v1h-1zM3 6h1v1h-1zM6 6h1v1h-1zM4 7h2v1h-2z"/></svg>');
        background-size: contain; background-repeat: no-repeat;
    }
    #key-hud {
        width: 40px; height: 40px; opacity: 0.2; transform: scale(0.8); transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path fill="%23ffd700" d="M7 14c-3.86 0-7-3.14-7-7s3.14-7 7-7 7 3.14 7 7c0 1.92-.78 3.66-2.04 4.93l.04.07 3 3 2-2 3 3-2 2 3 3-2 2-3-3-.07-.04c-1.27 1.26-3.01 2.04-4.93 2.04zm0-11c-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4-1.79-4-4-4z"/></svg>');
        background-size: contain; background-repeat: no-repeat;
    }
    .key-collected { opacity: 1 !important; transform: scale(1.2) !important; filter: drop-shadow(0 0 10px gold); }

    .screen-box {
        position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
        width: 85%; max-width: 500px;
        background: rgba(15, 10, 10, 0.98);
        border: 4px solid #8b0000;
        padding: 30px; text-align: center; color: #fff;
        box-shadow: 0 0 50px rgba(139, 0, 0, 0.6);
        pointer-events: auto; border-radius: 8px;
    }

    button {
        padding: 15px 30px; font-family: 'Press Start 2P', cursive; font-size: 12px;
        background: #b71c1c; color: #fff; border: 2px solid #ff5252;
        cursor: pointer; margin-top: 25px; text-transform: uppercase;
        box-shadow: 0 5px 0 #7f0000; transition: transform 0.1s; pointer-events: auto;
    }
    button:active { transform: translateY(5px); box-shadow: none; }

    #game-msg { 
        display: none; position: absolute; top: 20%; width: 100%; 
        text-align: center; color: #ffd700; font-size: 14px; line-height: 1.5;
        text-shadow: 2px 2px 0 #000; z-index: 20; 
        animation: popIn 0.3s ease-out;
    }
    @keyframes popIn { from { transform: scale(0); } to { transform: scale(1); } }

    #controls { position: absolute; bottom: 30px; left: 0; width: 100%; display: none; justify-content: space-between; padding: 0 30px; box-sizing: border-box; pointer-events: none; z-index: 80; }
    .btn { width: 70px; height: 70px; background: rgba(255,255,255,0.15); border-radius: 50%; pointer-events: auto; display: flex; justify-content: center; align-items: center; color: white; font-size: 24px; border: 2px solid rgba(255,255,255,0.3); backdrop-filter: blur(5px); box-shadow: 0 4px 10px rgba(0,0,0,0.5); }
    .btn:active { background: rgba(255,255,255,0.4); transform: scale(0.95); }

    #win-screen {
        display: none;
        position: fixed; 
        top: 50%; left: 50%;
        transform: translate(-50%, -50%) rotate(-2deg);
        width: 90%; max-width: 400px;
        background: #fff8e1; color: #3e2723;
        border: 10px solid #fff; 
        outline: 1px dashed #ccc;
        padding: 40px;
        box-shadow: 0 20px 50px rgba(0,0,0,0.8);
        z-index: 1000;
        pointer-events: auto;
    }
    #win-screen h1 { font-family: 'Cinzel', serif; color: #d32f2f; margin-bottom: 20px; font-size: 22px; }
    #win-screen p { font-family: 'Dancing Script', cursive; font-size: 22px; line-height: 1.4; font-weight: bold; text-align: left; margin-bottom: 20px; }
</style>
</head>
<body>

<canvas id="gameCanvas"></canvas>

<div id="ui">
    <div id="hud-top" style="display:none;">
        <div class="heart-container" id="hearts-container">
            <div class="heart"></div><div class="heart"></div><div class="heart"></div>
        </div>
        <div id="key-hud"></div>
    </div>

    <div id="start-screen" class="screen-box">
        <h1 style="color:#ff5252; margin-bottom:20px; text-shadow: 3px 3px #000;">LA FORTEZZA</h1>
        <p style="font-size:10px; line-height:2; color:#ccc; text-align: left;">
            1. Vai a <strong>DESTRA</strong>: Supera le guardie per trovare la Chiave.<br>
            2. Torna a <strong>SINISTRA</strong>: Attraversa le grotte mobili per trovare la Cella.<br>
            3. Scappa prima del crollo.<br><br>
            <em>Attenzione: Le guardie pattugliano la zona. Saltaci sopra per eliminarle.</em>
        </p>
        <button onclick="startGame()">MISSIONE START</button>
    </div>

    <div id="game-msg"></div>

    <div id="win-screen">
        <h1>AMORE MIO...</h1>
        <p id="final-text"></p>
        <button style="background:#d32f2f; border:none; color:white; width:100%;" onclick="location.reload()">RICOMINCIA ❤️</button>
    </div>
</div>

<div id="controls">
    <div style="display:flex; gap:20px; pointer-events:none">
        <div class="btn" id="btnLeft">◀</div>
        <div class="btn" id="btnRight">▶</div>
    </div>
    <div class="btn" id="btnJump">▲</div>
</div>

<script>
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');

let ZOOM = 0.6; 
const GRAVITY = 0.6;
const JUMP_PWR = -13;
const SPEED = 5.5;
const WORLD_KILL_Y = 1200;

let gameState = 'MENU'; 
let scene = 'DUNGEON'; 
let frame = 0;
let shakeIntensity = 0;
let escapeMode = false;

const keys = { left: false, right: false, jump: false };

let player = { x: 0, y: 0, w: 30, h: 46, vx: 0, vy: 0, onGround: false, facingRight: true, hp: 3, invuln: 0 };
let rocco = { x: 0, y: 0, active: false };

let platforms = [];
let enemies = []; 
let bgDetails = []; 
let debris = [];
let keyItem = { x: 0, y: 0, taken: false };
let cellDoor = { x: 0, y: 0, open: false };
let exitZone = { x: 0, y: 0 };

let cameraX = 0, cameraY = 0;

function init() {
    resize();
    generateBg();
    buildLevel();
    requestAnimationFrame(loop);
}

function startGame() {
    document.getElementById('start-screen').style.display = 'none';
    document.getElementById('hud-top').style.display = 'flex';
    if('ontouchstart' in window) document.getElementById('controls').style.display = 'flex';
    gameState = 'PLAYING';
    scene = 'DUNGEON';
    spawnPlayer();
}

function resize() {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
}
window.addEventListener('resize', resize);

function buildLevel() {
    platforms = [];
    enemies = [];
    platforms.push({ x: -200, y: 100, w: 400, h: 400 });
    platforms.push({ x: 300, y: 50, w: 100, h: 20 });
    platforms.push({ x: 500, y: 0, w: 150, h: 20 });
    enemies.push({ x: 520, y: -40, minX: 500, maxX: 630, speed: 2, dir: 1, dead: false });
    platforms.push({ x: 750, y: -50, w: 80, h: 20 });
    platforms.push({ x: 950, y: -100, w: 100, h: 20, type: 'movY', min: -350, max: -50, vy: -2 });
    platforms.push({ x: 1100, y: -300, w: 300, h: 20 });
    enemies.push({ x: 1150, y: -340, minX: 1100, maxX: 1350, speed: 3, dir: 1, dead: false });
    keyItem = { x: 1350, y: -350, taken: false };
    platforms.push({ x: -350, y: 50, w: 100, h: 20 });
    platforms.push({ x: -600, y: 0, w: 100, h: 20, type: 'movX', min: -600, max: -450, vx: 2 });
    platforms.push({ x: -850, y: -50, w: 100, h: 20, type: 'movX', min: -850, max: -700, vx: -2 });
    platforms.push({ x: -1100, y: -100, w: 200, h: 20 }); 
    enemies.push({ x: -1050, y: -140, minX: -1100, maxX: -950, speed: 1.5, dir: 1, dead: false });
    cellDoor = { x: -1200, y: -270, w: 80, h: 170, open: false };
    platforms.push({ x: 1600, y: 200, w: 600, h: 50 });
    exitZone = { x: 2000, y: 100 };
}

function spawnPlayer() {
    player.x = 0; player.y = 0; player.vx = 0; player.vy = 0;
    player.hp = 3; player.invuln = 0;
    cameraX = 0; 
    enemies.forEach(e => e.dead = false);
    updateHeartsUI();
}

function updateHeartsUI() {
    const container = document.getElementById('hearts-container');
    container.innerHTML = '';
    for(let i=0; i<player.hp; i++) {
        container.innerHTML += '<div class="heart"></div>';
    }
}

function hitPlayer() {
    if (player.invuln > 0) return;
    player.hp--;
    updateHeartsUI();
    if (player.hp <= 0) {
        spawnPlayer(); 
        shakeIntensity = 5; setTimeout(()=>shakeIntensity=0, 200);
    } else {
        player.invuln = 60; 
        player.vy = -8; 
        player.vx = -player.vx;
        shakeIntensity = 2; setTimeout(()=>shakeIntensity=0, 100);
    }
}

function generateBg() {
    bgDetails = [];
    for(let i=0; i<80; i++) {
        bgDetails.push({
            x: (Math.random() * 4000) - 2000,
            y: (Math.random() * 2000) - 1000,
            w: Math.random() * 30 + 10, h: Math.random() * 15 + 5,
            c: Math.random() > 0.5 ? '#111' : '#1a1a1a'
        });
    }
}

function loop() {
    update();
    draw();
    requestAnimationFrame(loop);
}

function update() {
    if (gameState !== 'PLAYING') return;
    frame++;
    if (scene === 'DUNGEON') {
        if (player.invuln > 0) player.invuln--;
        if (keys.left) { player.vx = -SPEED; player.facingRight = false; }
        else if (keys.right) { player.vx = SPEED; player.facingRight = true; }
        else { player.vx *= 0.8; }
        player.vy += GRAVITY;
        player.x += player.vx;
        player.y += player.vy;
        player.onGround = false;
        platforms.forEach(p => {
            if(p.type === 'movX') { p.x += p.vx; if(p.x < p.min || p.x > p.max) p.vx *= -1; }
            if(p.type === 'movY') { p.y += p.vy; if(p.y < p.min || p.y > p.max) p.vy *= -1; }
            if (player.vy > 0 && player.x + player.w > p.x + 5 && player.x < p.x + p.w - 5 && player.y + player.h > p.y && player.y + player.h < p.y + p.h + 20) {
                player.y = p.y - player.h;
                player.vy = 0;
                player.onGround = true;
                if(p.type === 'movX') player.x += p.vx; 
            }
        });
        if (keys.jump && player.onGround) player.vy = JUMP_PWR;
        if (player.y > WORLD_KILL_Y) hitPlayer();
        enemies.forEach(e => {
            if(e.dead) return;
            e.x += e.speed * e.dir;
            if(e.x > e.maxX || e.x < e.minX) e.dir *= -1;
            if (checkRectOverlap(player, {x:e.x, y:e.y, w:30, h:30})) {
                if (player.vy > 0 && player.y + player.h < e.y + 20) {
                    e.dead = true;
                    player.vy = -8; 
                    createDebris(e.x, e.y, 10, '#f00'); 
                } else { hitPlayer(); }
            }
        });
        if (!keyItem.taken && checkRectOverlap(player, {x:keyItem.x, y:keyItem.y, w:40, h:40})) {
            keyItem.taken = true;
            document.getElementById('key-hud').classList.add('key-collected');
            showMsg("CHIAVE PRESA! ORA TORNA INDIETRO ALLA CELLA!");
            shakeIntensity = 2; setTimeout(()=>shakeIntensity=0, 500);
        }
        if (keyItem.taken && !cellDoor.open && checkRectOverlap(player, {x:cellDoor.x-50, y:cellDoor.y, w:150, h:170})) {
            cellDoor.open = true;
            rocco.active = true;
            rocco.x = cellDoor.x + 20; rocco.y = cellDoor.y + 130;
            escapeMode = true;
            shakeIntensity = 6;
            showMsg("ROCCO LIBERO! VIA VERSO DESTRA! CORRI!");
        }
        if (rocco.active) {
            let target = player.x - (player.facingRight ? 40 : -40);
            rocco.x += (target - rocco.x) * 0.09;
            rocco.y += (player.y - rocco.y) * 0.1;
        }
        if (escapeMode) {
            if (frame % 8 === 0) {
                debris.push({ x: cameraX + Math.random()*canvas.width - canvas.width/2, y: cameraY - 400, vx: 0, vy: Math.random()*10+5, s: Math.random()*15+5 });
            }
            if (player.x > 1800) { transitionToHome(); }
        }
        for(let i=debris.length-1; i>=0; i--) {
            debris[i].y += debris[i].vy;
            if(debris[i].y > cameraY + 600) debris.splice(i,1);
        }
        let targetCamX = player.x;
        let targetCamY = player.y - 100;
        cameraX += (targetCamX - cameraX) * 0.1;
        cameraY += (targetCamY - cameraY) * 0.1;
    } else if (scene === 'HOME') {
        if (player.x < 100) {
            player.x += 1.5; rocco.x = player.x - 45;
            player.facingRight = true;
            player.y = (Math.sin(frame*0.5)*2);
            rocco.y = (Math.sin((frame+2)*0.5)*2);
        } else {
            player.facingRight = false; 
            if (document.getElementById('win-screen').style.display !== 'block') { showFinalLetter(); }
        }
    }
}

function draw() {
    ctx.setTransform(1, 0, 0, 1, 0, 0);
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    let shakeX = (Math.random()-0.5)*shakeIntensity;
    let shakeY = (Math.random()-0.5)*shakeIntensity;
    if (scene === 'DUNGEON') {
        let grad = ctx.createLinearGradient(0,0,0,canvas.height);
        grad.addColorStop(0, '#050505'); grad.addColorStop(1, '#1a0505');
        ctx.fillStyle = grad; ctx.fillRect(0,0,canvas.width, canvas.height);
    } else {
        ctx.fillStyle = '#ffecb3'; ctx.fillRect(0,0,canvas.width, canvas.height); 
        ctx.fillStyle = '#5d4037'; ctx.fillRect(0, canvas.height/2 + 46, canvas.width, 200); 
    }
    ctx.save();
    if (scene === 'DUNGEON') {
        ctx.translate(canvas.width/2 - cameraX + shakeX, canvas.height/2 - cameraY + shakeY);
        ctx.scale(ZOOM, ZOOM);
        ctx.fillStyle = '#111';
        bgDetails.forEach(b => ctx.fillRect(b.x, b.y, b.w, b.h));
        platforms.forEach(p => {
            ctx.fillStyle = '#2b1b17'; 
            ctx.fillRect(p.x, p.y, p.w, p.h);
            ctx.strokeStyle = '#3e2723'; ctx.lineWidth = 3; ctx.strokeRect(p.x, p.y, p.w, p.h);
            ctx.fillStyle = '#1b5e20'; ctx.fillRect(p.x, p.y, p.w, 4);
        });
        ctx.fillStyle = '#000'; ctx.fillRect(cellDoor.x, cellDoor.y, cellDoor.w, cellDoor.h);
        if(!cellDoor.open) {
            ctx.fillStyle = '#7f8c8d';
            for(let i=10; i<cellDoor.w; i+=20) ctx.fillRect(cellDoor.x+i, cellDoor.y, 6, cellDoor.h);
        }
        enemies.forEach(e => { if(!e.dead) drawEnemy(e.x, e.y, e.dir); });
        if (!keyItem.taken) drawRealKey(keyItem.x, keyItem.y);
        ctx.fillStyle = '#555';
        debris.forEach(d => ctx.fillRect(d.x, d.y, d.s, d.s));
    } else {
        ctx.translate(canvas.width/2, canvas.height/2);
        ctx.scale(1.5, 1.5); 
    }
    if (rocco.active || scene === 'HOME') drawChar(rocco.x, rocco.y, (scene==='HOME'?true:player.facingRight), true);
    if (player.invuln % 10 < 5) { drawChar(player.x, player.y, player.facingRight, false); }
    ctx.restore();
}

function drawRealKey(x, y) {
    let hover = Math.sin(frame*0.1) * 5;
    let kx = x, ky = y + hover;
    ctx.shadowColor = 'gold'; ctx.shadowBlur = 15;
    ctx.fillStyle = '#ffd700';
    ctx.beginPath(); ctx.arc(kx, ky, 10, 0, Math.PI*2); ctx.fill();
    ctx.globalCompositeOperation = 'destination-out';
    ctx.beginPath(); ctx.arc(kx, ky, 4, 0, Math.PI*2); ctx.fill();
    ctx.globalCompositeOperation = 'source-over';
    ctx.fillRect(kx - 3, ky + 8, 6, 25);
    ctx.fillRect(kx + 3, ky + 25, 8, 5); ctx.fillRect(kx + 3, ky + 18, 6, 4);
    ctx.shadowBlur = 0;
}

function drawEnemy(x, y, dir) {
    ctx.fillStyle = '#b71c1c'; ctx.fillRect(x, y, 30, 30);
    ctx.fillStyle = '#fff'; ctx.fillRect(x + (dir>0?18:4), y+5, 8, 8);
    ctx.fillStyle = '#000'; ctx.fillRect(x + (dir>0?22:6), y+7, 2, 2);
    ctx.fillStyle = '#000'; ctx.beginPath(); ctx.moveTo(x + (dir>0?16:2), y+4); ctx.lineTo(x + (dir>0?28:14), y+8); ctx.stroke();
}

function drawChar(x, y, facingRight, isBoy) {
    ctx.fillStyle = "rgba(0,0,0,0.2)"; ctx.fillRect(x+5, y+44, 20, 3);
    ctx.fillStyle = isBoy ? "#1565c0" : "#d81b60"; ctx.fillRect(x + 4, y + 20, 22, 18);
    ctx.fillStyle = "#212121"; ctx.fillRect(x + 4, y + 38, 22, 8); 
    let w = (scene==='DUNGEON' && Math.abs(player.vx) > 0.1) ? Math.sin(frame*0.5)*4 : 0;
    ctx.fillRect(x + 6 - w, y + 46, 8, 10); ctx.fillRect(x + 16 + w, y + 46, 8, 10);
    ctx.fillStyle = "#ffccbc"; ctx.fillRect(x + 2, y + 2, 26, 18);
    ctx.fillStyle = isBoy ? "#3e2723" : "#4e342e";
    if (isBoy) {
        ctx.fillRect(x + 2, y, 26, 6); ctx.fillRect(x + 2, y + 2, 6, 10);
    } else {
        ctx.fillRect(x, y - 4, 30, 10); ctx.fillRect(x + 2, y + 2, 26, 6); 
        if (facingRight) { ctx.fillRect(x - 4, y + 2, 10, 36); } else { ctx.fillRect(x + 24, y + 2, 10, 36); }
    }
    ctx.fillStyle = "#000"; let ex = facingRight ? 16 : 6;
    ctx.fillRect(x + ex, y + 10, 3, 3); ctx.fillRect(x + ex + 6, y + 10, 3, 3);
}

function checkRectOverlap(r1, r2) { return (r1.x < r2.x + r2.w && r1.x + r1.w > r2.x && r1.y < r2.y + r2.h && r1.y + r1.h > r2.y); }
function createDebris(x, y, count, color) { for(let i=0; i<count; i++) debris.push({x:x, y:y, vx:(Math.random()-0.5)*5, vy:(Math.random()-0.5)*5, s:4, c:color}); }
function showMsg(txt) { const el = document.getElementById('game-msg'); el.innerHTML = txt; el.style.display = 'block'; setTimeout(() => el.style.display = 'none', 4000); }

function transitionToHome() {
    scene = 'HOME';
    player.x = -100; player.y = 0; player.vx = 0; player.vy = 0;
    rocco.x = -150; rocco.y = 0;
    shakeIntensity = 0;
    document.getElementById('hud-top').style.display = 'none';
    document.getElementById('controls').style.display = 'none';
}

function showFinalLetter() {
    const winScreen = document.getElementById('win-screen');
    const textEl = document.getElementById('final-text');
    winScreen.style.display = 'block';
    textEl.innerHTML = "Ti amo tanto amore mio,<br>grazie per avermi salvato.<br><br>Buon San Valentino<br><br>Con affetto,<br>Rocco ❤️";
}

function bindKey(id, k) {
    const btn = document.getElementById(id);
    const d = (e) => { e.preventDefault(); keys[k] = true; };
    const u = (e) => { e.preventDefault(); keys[k] = false; };
    btn.addEventListener('mousedown', d); btn.addEventListener('mouseup', u);
    btn.addEventListener('touchstart', d); btn.addEventListener('touchend', u);
}
bindKey('btnLeft', 'left'); bindKey('btnRight', 'right'); bindKey('btnJump', 'jump');

window.addEventListener('keydown', e => {
    if(e.key==='ArrowLeft') keys.left = true;
    if(e.key==='ArrowRight') keys.right = true;
    if(e.key===' ' || e.key==='ArrowUp') keys.jump = true;
});
window.addEventListener('keyup', e => {
    if(e.key==='ArrowLeft') keys.left = false;
    if(e.key==='ArrowRight') keys.right = false;
    if(e.key===' ' || e.key==='ArrowUp') keys.jump = false;
});

init();
</script>
</body>
</html>
